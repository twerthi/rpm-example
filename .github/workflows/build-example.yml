name: Example build

on:
  workflow_dispatch:

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set Version
      run: echo "PACKAGE_VERSION=25" >> $GITHUB_ENV

    - name: Create a release in Octopus Deploy üêô
      id: create_a_release_in_octopus_deploy
      uses: OctopusDeploy/create-release-action@v4
      env:
        OCTOPUS_API_KEY: ${{ secrets.API_KEY  }}
        OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
        OCTOPUS_SPACE: 'Shawn Sesna'
      with:
        project: 'RPM Example'
#        release_number: ${{ env.PACKAGE_VERSION }}
        custom_fields: |
          RPM.Package.Version:${{ env.PACKAGE_VERSION }}

    - name: Deploy a release in Octopus Deploy üêô
      id: deploy_a_release_in_octopus_deploy
      uses: OctopusDeploy/deploy-release-action@v4
      env:
        OCTOPUS_API_KEY: ${{ secrets.API_KEY  }}
        OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
        OCTOPUS_SPACE: 'Shawn Sesna'
      with:
        project: 'RPM Example'
#        release_number: ${{ env.PACKAGE_VERSION }}
        release_number: ${{ steps.create_a_release_in_octopus_deploy.outputs.release_number }}
        environments: |
          Development

    - name: Await task in Octopus Deploy üêô
      uses: OctopusDeploy/await-task-action@v4
      env:
        OCTOPUS_API_KEY: ${{ secrets.API_KEY  }}
        OCTOPUS_URL: ${{ secrets.OCTOPUS_URL }}
        OCTOPUS_SPACE: 'Shawn Sesna'
      with:
        server_task_id: ${{ fromJson(steps.deploy_a_release_in_octopus_deploy.outputs.server_tasks)[0].serverTaskId }}